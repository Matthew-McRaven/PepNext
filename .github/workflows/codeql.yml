# Notice below generated by GitHub.
# I removed the cloning code, and added my own build steps.

# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
name: CodeQL
on:
  push:
  schedule:
    - cron: '0 21 * * 5'
  workflow_dispatch:

jobs:
  branch_info:
    name: Gather branch info
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.branch }}
      not_default: ${{ steps.branch.outputs.not_default }}
    steps:
      - name: set branch info
        id: branch
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            export BRANCH="${GITHUB_REF##*/}"
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            export BRANCH="${$GITHUB_BASE_REF}"
          elif [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            export BRANCH="main"
          else
            echo "unknown event" && exit 1;
          fi
          if [ "$BRANCH" = "main" ]; then
            echo "not_default=false" >> $GITHUB_OUTPUT
          else
            echo "not_default=true" >> $GITHUB_OUTPUT
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Output is:"
          cat $GITHUB_OUTPUT

  start_codeql:
    name: Run CodeQL
    needs: branch_info
    uses: ./.github/workflows/build.yml
    permissions:
      actions: read
      contents: read
      security-events: write
    with:
      name: "Ubuntu 22.04; GCC + CodeQL"
      cache_name: "ubuntu-gcc" # Must match cache name in ci.yml
      runs-on: "ubuntu-latest"
      image: "ghcr.io/matthew-mcraven/pepp/dev-gcc:v0.10.0"
      cmake_generator: Ninja
      compiler_launcher: ccache
      codeql: True
      variant: "debug"
      not_default: ${{ !!needs.branch_info.outputs.not_default }}
