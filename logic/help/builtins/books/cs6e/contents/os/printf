LDWA      0x45,i
STWA      -2,s
STWA      -6,s
LDWA      in,i
STWA      -4,s
STWA      -8,s
SUBSP     8,i
CALL      fnPrintf
ADDSP     8,i
RET
in:      .ASCII "Hi %d %s %h\x00"
;
firstVal: .EQUATE  10
str:      .EQUATE  8
;retAddr: .WORD    6
plceIdx:  .EQUATE  4         ;Placeholder variadic array next idx
strIdx:   .EQUATE  2
status:   .EQUATE  1
lstChar:  .EQUATE  0
;Constants
lstPlce:  .EQUATE  1         ;Last char was %
lstEsc:   .EQUATE  2         ;Last char was \\
fnPrintf: SUBSP    6,i
          LDWA     0,i
          LDWX     0,i
          STWX     lstChar,s
          STWX     strIdx,s
lpPrintf: LDBA     str, sfX
          LDBA     str, sfx
          BREQ     ePrintf
          ADDX     1,i
          STWX     strIdx, s
         ;
          LDBX     status, s
          ANDX     lstPlce, i
          BRNE     detPlce
          LDBX     status, s
          CPWA     '%', i
          BREQ     strtPlce
          CPWA     '\\', i
          BREQ     strtEsc
printCh:  STBA     charOut,d
          ;printf reset status
printfRs: LDBA     0,i
          STBA     status,s
printfNx: LDWX     strIdx, s
          BR       lpPrintf
;Determine what to do with placeholder
strtPlce: LDBX     lstPlce, i
          STBX     status, s
          BR       printfNx
strtEsc:  LDBX     lstEsc,i
          STBX     status, s
          BR       printfNx
detPlce:  LDBX     status,s
          ANDX     lstEsc,i
          BRNE     printCh
          LDWX     plceIdx,s
          ANDA     '_',i   ;Convert to uppercase
          CPWA     'H',i
          BREQ     printfH
          CPWA     'D',i
          BREQ     printfD
          CPWA     'S',i
          BREQ     printfS
          ; Illegal placeholder, print message and shutdown
          STBA     lstChar,s ;Must cache last character, overriden by printMsg
          @STRO    mBadPlce,d
          ;LDWA     mBadPlce,i
          ;STWA     -2,s
          ;SUBSP    2,i
          ;CALL     printMsg
          ;ADDSP    2,i
          LDBA     lstChar,s
          STBA     charOut,d
          BR       shutdown
ePrintf:  ADDSP    6,i
          RET
;
printfH:  CALL     ldNxtAd   ;X preserved
          STWA     -2,s
          SUBSP    2,i
          ;CALL     hexPrint
          @HEXO    0,s
          ADDSP    2,i
          BR       plceFix
printfD:  CALL     ldNxtAd   ;X preserved
          STWA     -2,s
          SUBSP    2,i
          ;CALL     numPrint
          @DECO    0,s
          ADDSP    2,i
          BR       plceFix
printfS:  CALL     ldNxtAd   ;X preserved
          STWA     -2,s
          SUBSP    2,i
          ;CALL     prntMsg
          @STRO    0,sf
          ADDSP    2,i
plceFix:  ADDX     2,i
          STWX     plceIdx,s
          BR       printfRs
;
firstVal2: .EQUATE  12
          ; Load the value into As
ldNxtAd:  LDWA     firstVal2,sx
          ADDA     2,i
          STWA     firstVal2,sx
          SUBA     2,i
          RET
mBadPlce: .ASCII "Illegal placeholder %\x00"
shutdown: ret
